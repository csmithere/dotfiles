#!/bin/bash
# Fetches a fresh Gmail OAuth2 access token, caching until expiry.
# Used by mbsync's PassCmd.

set -euo pipefail

CACHE_FILE="${HOME}/.cache/gmail-oauth2-token.json"
CLIENT_ID="{{ onepasswordRead "op://BigID/Gmail OAuth/client_id" }}"
CLIENT_SECRET="{{ onepasswordRead "op://BigID/Gmail OAuth/client_secret" }}"
REFRESH_TOKEN="{{ onepasswordRead "op://BigID/Gmail OAuth/refresh_token" }}"
TOKEN_ENDPOINT="{{ onepasswordRead "op://BigID/Gmail OAuth/token_endpoint" }}"

mkdir -p "$(dirname "$CACHE_FILE")"

# Check cache
if [ -f "$CACHE_FILE" ]; then
    expires_at=$(jq -r '.expires_at // 0' "$CACHE_FILE" 2>/dev/null || echo 0)
    now=$(date +%s)
    if [ "$now" -lt "$expires_at" ]; then
        jq -r '.access_token' "$CACHE_FILE"
        exit 0
    fi
fi

# Fetch new token
response=$(curl -s -X POST "$TOKEN_ENDPOINT" \
    -d "client_id=${CLIENT_ID}" \
    -d "client_secret=${CLIENT_SECRET}" \
    -d "refresh_token=${REFRESH_TOKEN}" \
    -d "grant_type=refresh_token")

access_token=$(echo "$response" | jq -r '.access_token // empty')
expires_in=$(echo "$response" | jq -r '.expires_in // 3600')

if [ -z "$access_token" ]; then
    echo "Failed to get access token" >&2
    echo "$response" >&2
    exit 1
fi

# Cache with expiry (subtract 60s buffer)
now=$(date +%s)
expires_at=$((now + expires_in - 60))
jq -n --arg token "$access_token" --argjson expires "$expires_at" \
    '{access_token: $token, expires_at: $expires}' > "$CACHE_FILE"
chmod 600 "$CACHE_FILE"

echo "$access_token"
